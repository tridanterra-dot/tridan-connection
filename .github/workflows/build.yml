name: Build APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install system dependencies (completo con libltdl-dev)
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y \
          build-essential git zip unzip openjdk-17-jdk \
          autoconf automake libtool libltdl-dev libffi-dev \
          libssl-dev zlib1g-dev pkg-config ccache \
          libncurses5-dev libncursesw5-dev cmake
        
        echo "‚úÖ Dependencias del sistema instaladas"
    
    - name: Install Python tools
      run: |
        pip install --upgrade pip setuptools wheel
        pip install buildozer cython
        echo "‚úÖ Buildozer instalado"
        buildozer --version
    
    - name: Download and patch pyjnius (master con fix Python 3)
      run: |
        echo "üîß Clonando pyjnius desde master..."
        git clone https://github.com/kivy/pyjnius.git /tmp/pyjnius_master
        cd /tmp/pyjnius_master
        
        echo "üìã Revisando estado de 'long'..."
        if grep -q "isinstance(arg, long)" jnius/jnius_utils.pxi; then
          echo "‚ö†Ô∏è Master a√∫n tiene 'long' - Aplicando parche..."
          
          # Parche completo: todas las referencias a 'long'
          sed -i 's/isinstance(\([^,]*\), long)/isinstance(\1, int)/g' jnius/jnius_utils.pxi
          sed -i 's/(long)/int/g' jnius/jnius_utils.pxi
          
          echo "‚úÖ Parche aplicado"
        else
          echo "‚úÖ Master ya tiene el fix"
        fi
        
        echo ""
        echo "üîç Verificaci√≥n final - Buscando 'long':"
        grep -n "long" jnius/jnius_utils.pxi || echo "‚úÖ Sin referencias a 'long' - PERFECTO"
        echo ""
        
        echo "üì¶ Instalando pyjnius parcheado..."
        pip install -e .
        
        echo "‚úÖ pyjnius instalado desde source parcheado"
        python -c "import jnius; print('pyjnius version:', jnius.__version__)"
    
    - name: Create buildozer.spec (SIN pyjnius en requirements)
      run: |
        cat > buildozer.spec << 'EOF'
        [app]
        title = Tridan Connection
        package.name = tridan
        package.domain = org.test
        source.dir = .
        source.include_exts = py
        version = 1.0
        requirements = python3,kivy
        orientation = portrait
        fullscreen = 0

        [buildozer]
        log_level = 2
        warn_on_root = 0

        android.permissions = INTERNET,BLUETOOTH,BLUETOOTH_ADMIN,ACCESS_FINE_LOCATION
        android.api = 33
        android.minapi = 21
        android.ndk = 25b
        android.archs = arm64-v8a
        android.accept_sdk_license = True
        android.skip_update = False
        android.copy_libs = 1
        EOF
        
        echo "‚úÖ buildozer.spec creado (sin pyjnius)"
        echo ""
        cat buildozer.spec
    
    - name: Build APK con pyjnius pre-instalado
      run: |
        echo ""
        echo "=================================="
        echo "üî® INICIANDO BUILD DE TRIDAN"
        echo "=================================="
        echo "‚è∞ Inicio: $(date)"
        echo ""
        
        # El build usar√° el pyjnius que ya instalamos
        yes | buildozer -v android debug 2>&1
        
        echo ""
        echo "‚è∞ Fin: $(date)"
        echo "=================================="
        echo ""
        
        if [ -d "bin" ]; then
          echo "üìÅ Contenido de bin/:"
          ls -lh bin/
        else
          echo "‚ö†Ô∏è Carpeta bin/ no existe"
        fi
    
    - name: Upload APK
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: tridan-connection-apk
        path: bin/*.apk
        if-no-files-found: warn
    
    - name: Upload logs si falla
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: build-logs
        path: .buildozer/android/platform/build-*/
        if-no-files-found: ignore
