name: Build APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential git libffi-dev libssl-dev \
          libtool libtool-bin automake autoconf pkg-config openjdk-17-jdk
    
    - name: Install Buildozer
      run: |
        pip install buildozer cython
    
    - name: Patch pyjnius for Python 3
      run: |
        echo "ðŸ”§ Clonando y parcheando pyjnius..."
        
        # Clonar pyjnius
        git clone https://github.com/kivy/pyjnius.git /tmp/pyjnius
        cd /tmp/pyjnius
        
        # Aplicar parche: reemplazar 'long' por 'int' en Python 3
        echo "Aplicando parche para Python 3..."
        sed -i 's/isinstance(\([^,]*\), long)/isinstance(\1, int)/g' jnius/jnius_utils.pxi
        
        # Verificar que se aplicÃ³
        echo "âœ… Parche aplicado. Verificando..."
        grep -n "isinstance.*long" jnius/jnius_utils.pxi || echo "âœ… No quedan referencias a 'long'"
        
        # Crear directorio para recipe local
        mkdir -p $GITHUB_WORKSPACE/pyjnius_patched
        cp -r . $GITHUB_WORKSPACE/pyjnius_patched/
        
        echo "âœ… pyjnius parcheado listo en pyjnius_patched/"
    
    - name: Configure local recipes
      run: |
        # Crear directorio de recetas locales
        mkdir -p p4a-recipes/pyjnius
        cp -r $GITHUB_WORKSPACE/pyjnius_patched/* p4a-recipes/pyjnius/
        
        # Actualizar buildozer.spec para usar receta local
        echo "" >> buildozer.spec
        echo "p4a.local_recipes = ./p4a-recipes" >> buildozer.spec
        
        cat buildozer.spec
    
    - name: Build APK
      run: |
        echo "ðŸ”¨ Compilando APK con pyjnius parcheado..."
        yes | buildozer -v android debug || true
    
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: tridan-apk
        path: bin/*.apk
    
    - name: Upload build log
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: build-log
        path: .buildozer/logs/
